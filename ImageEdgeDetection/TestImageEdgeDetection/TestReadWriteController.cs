using Microsoft.VisualStudio.TestTools.UnitTesting;
using NSubstitute;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using ImageEdgeDetection;
using System.Drawing;
using ImageEdgeDetection.IOFiles;
using ImageEdgeDetection.Business;
using System.Drawing.Imaging;
using System.Runtime.InteropServices;

namespace TestImageEdgeDetection
{
    [TestClass]
    public class TestReadWriteController
    {
        Bitmap testImg = new Bitmap("../../imagesForTesting/testImg.png");

        [TestMethod]
        public void testReadImg()
        {           
            var ioRepository = Substitute.For<IReadWriteController>();
            ioRepository.read().Returns<Bitmap>(testImg);

            var logicRepository = Substitute.For<ImageEdgeDetection.Business.ILogicController>();
            LogicController inputImage = new LogicController(ioRepository);           

            Bitmap test = inputImage.readImage(ioRepository);

            ImageConverter imageConverter = new ImageConverter();
            byte[] resBytes = (byte[])imageConverter.ConvertTo(testImg, typeof(byte[]));

            String res = "89-50-4E-47-0D-0A-1A-0A-00-00-00-0D-49-48-44-52-00-00-00-1E-00-00-00-14-08-02-00-00-00-15-C9-1A-93-00-00-00-04-67-41-4D-41-00-00-B1-8E-7C-FB-51-93-00-00-00-20-63-48-52-4D-00-00-87-0F-00-00-8C-0F-00-00-FD-52-00-00-81-40-00-00-7D-79-00-00-E9-8B-00-00-3C-E5-00-00-19-CC-73-3C-85-77-00-00-0A-39-69-43-43-50-50-68-6F-74-6F-73-68-6F-70-20-49-43-43-20-70-72-6F-66-69-6C-65-00-00-48-C7-9D-96-77-54-54-D7-16-87-CF-BD-77-7A-A1-CD-30-02-52-86-DE-BB-C0-00-D2-7B-93-5E-45-61-98-19-60-28-03-0E-33-34-B1-21-A2-02-11-45-44-9A-22-48-50-C4-80-D1-50-24-56-44-B1-10-14-54-B0-07-24-08-28-31-18-45-54-2C-6F-46-D6-8B-AE-AC-BC-F7-F2-F2-FB-E3-AC-6F-ED-B3-F7-B9-FB-EC-BD-CF-5A-17-00-92-A7-2F-97-97-06-4B-01-90-CA-13-F0-83-3C-9C-E9-11-91-51-74-EC-00-80-01-1E-60-80-29-00-4C-56-46-BA-5F-B0-7B-08-10-C9-CB-CD-85-9E-21-72-02-5F-04-01-F0-7A-58-BC-02-70-D3-D0-33-80-4E-07-FF-9F-A4-59-E9-7C-81-E8-98-00-11-9B-B3-39-19-2C-11-17-88-38-25-4B-90-2E-B6-CF-8A-98-1A-97-2C-66-18-25-66-BE-28-41-11-CB-89-39-61-91-0D-3E-FB-2C-B2-A3-98-D9-A9-3C-B6-88-C5-39-A7-B3-53-D9-62-EE-15-F1-B6-4C-21-47-C4-88-AF-88-0B-33-B9-9C-2C-11-DF-12-B1-46-8A-30-95-2B-E2-37-E2-D8-54-0E-33-03-00-14-49-6C-17-70-58-89-22-36-11-31-89-1F-12-E4-22-E2-E5-00-E0-48-09-5F-71-DC-57-2C-E0-64-0B-C4-97-72-49-4B-CF-E1-73-13-12-05-74-1D-96-2E-DD-D4-DA-9A-41-F7-E4-64-A5-70-04-02-C3-00-26-2B-99-C9-67-D3-5D-D2-52-D3-99-BC-1C-00-16-EF-FC-59-32-E2-DA-D2-45-45-B6-34-B5-B6-B4-34-34-33-32-FD-AA-50-FF-75-F3-6F-4A-DC-DB-45-7A-19-F8-B9-67-10-AD-FF-8B-ED-AF-FC-D2-1A-00-60-CC-89-6A-B3-F3-8B-2D-AE-0A-80-CE-2D-00-C8-DD-FB-62-D3-38-00-80-A4-A8-6F-1D-D7-BF-BA-0F-4D-3C-2F-89-02-41-BA-8D-B1-71-56-56-96-11-97-C3-32-12-17-F4-0F-FD-4F-87-BF-A1-AF-BE-67-24-3E-EE-8F-F2-D0-5D-39-F1-4C-61-8A-80-2E-AE-1B-2B-2D-25-4D-C8-A7-67-A4-33-59-1C-BA-E1-9F-87-F8-1F-07-FE-75-1E-06-41-9C-78-0E-9F-C3-13-45-84-89-A6-8C-CB-4B-10-B5-9B-C7-E6-0A-B8-69-3C-3A-97-F7-9F-9A-F8-0F-C3-FE-A4-C5-B9-16-89-D2-F8-11-50-63-8C-80-D4-75-2A-40-7E-ED-07-28-0A-11-20-D1-FB-C5-5D-FF-A3-6F-BE-F8-30-20-7E-79-E1-2A-93-8B-73-FF-EF-37-FD-67-C1-A5-E2-25-83-9B-F0-39-CE-25-28-84-CE-12-F2-33-17-F7-C4-CF-12-A0-01-01-48-02-2A-90-07-CA-40-1D-E8-00-43-60-06-AC-80-2D-70-04-6E-C0-1B-F8-83-10-10-09-56-03-16-48-04-A9-80-0F-B2-40-1E-D8-04-0A-41-31-D8-09-F6-80-6A-50-07-1A-41-33-68-05-C7-41-27-38-05-CE-83-4B-E0-1A-B8-01-6E-83-FB-60-14-4C-80-67-60-16-BC-06-0B-10-04-61-21-32-44-81-E4-21-15-48-13-D2-87-CC-20-06-64-0F-B9-41-BE-50-10-14-09-C5-42-09-10-0F-12-42-79-D0-66-A8-18-2A-83-AA-A1-7A-A8-19-FA-1E-3A-09-9D-87-AE-40-83-D0-5D-68-0C-9A-86-7E-87-DE-C1-08-4C-82-A9-B0-12-AC-05-1B-C3-0C-D8-09-F6-81-43-E0-55-70-02-BC-06-CE-85-0B-E0-1D-70-25-DC-00-1F-85-3B-E0-F3-F0-35-F8-36-3C-0A-3F-83-E7-10-80-10-11-1A-A2-8A-18-22-0C-C4-05-F1-47-A2-90-78-84-8F-AC-47-8A-90-0A-A4-01-69-45-BA-91-3E-E4-26-32-8A-CC-20-6F-51-18-14-05-45-47-19-A2-6C-51-9E-A8-50-14-0B-B5-06-B5-1E-55-82-AA-46-1D-46-75-A0-7A-51-37-51-63-A8-59-D4-47-34-19-AD-88-D6-47-DB-A0-BD-D0-11-E8-04-74-16-BA-10-5D-81-6E-42-B7-A3-2F-A2-6F-A3-27-D0-AF-31-18-0C-0D-A3-8D-B1-C2-78-62-22-31-49-98-B5-98-12-CC-3E-4C-1B-E6-1C-66-10-33-8E-99-C3-62-B1-F2-58-7D-AC-1D-D6-1F-CB-C4-0A-B0-85-D8-2A-EC-51-EC-59-EC-10-76-02-FB-06-47-C4-A9-E0-CC-70-EE-B8-28-1C-0F-97-8F-AB-C0-1D-C1-9D-C1-0D-E1-26-71-0B-78-29-BC-26-DE-06-EF-8F-67-E3-73-F0-A5-F8-46-7C-37-FE-3A-7E-02-BF-40-90-26-68-13-EC-08-21-84-24-C2-26-42-25-A1-95-70-91-F0-80-F0-92-48-24-AA-11-AD-89-81-44-2E-71-23-B1-92-78-8C-78-99-38-46-7C-4B-92-21-E9-91-5C-48-D1-24-21-69-07-E9-10-E9-1C-E9-2E-E9-25-99-4C-D6-22-3B-92-A3-C8-02-F2-0E-72-33-F9-02-F9-11-F9-8D-04-45-C2-48-C2-4B-82-2D-B1-41-A2-46-A2-43-62-48-E2-B9-24-5E-52-53-D2-49-72-B5-64-AE-64-85-E4-09-C9-EB-92-33-52-78-29-2D-29-17-29-A6-D4-7A-A9-1A-A9-93-52-23-52-73-D2-14-69-53-69-7F-E9-54-E9-12-E9-23-D2-57-A4-A7-64-B0-32-5A-32-6E-32-6C-99-02-99-83-32-17-64-C6-29-08-45-9D-E2-42-61-51-36-53-1A-29-17-29-13-54-0C-55-9B-EA-45-4D-A2-16-53-BF-A3-0E-50-67-65-65-64-97-C9-86-C9-66-CB-D6-C8-9E-96-1D-A5-21-34-2D-9A-17-2D-85-56-4A-3B-4E-1B-A6-BD-5B-A2-B4-C4-69-09-67-C9-F6-25-AD-4B-86-96-CC-CB-2D-95-73-94-E3-C8-15-C9-B5-C9-DD-96-7B-27-4F-97-77-93-4F-96-DF-25-DF-29-FF-50-01-A5-A0-A7-10-A8-90-A5-B0-5F-E1-A2-C2-CC-52-EA-52-DB-A5-AC-A5-45-4B-8F-2F-BD-A7-08-2B-EA-29-06-29-AE-55-3C-A8-D8-AF-38-A7-A4-AC-E4-A1-94-AE-54-A5-74-41-69-46-99-A6-EC-A8-9C-A4-5C-AE-7C-46-79-5A-85-A2-62-AF-C2-55-29-57-39-AB-F2-94-2E-4B-77-A2-A7-D0-2B-E9-BD-F4-59-55-45-55-4F-55-A1-6A-BD-EA-80-EA-82-9A-B6-5A-A8-5A-BE-5A-9B-DA-43-75-82-3A-43-3D-5E-BD-5C-BD-47-7D-56-43-45-C3-4F-23-4F-A3-45-E3-9E-26-5E-93-A1-99-A8-B9-57-B3-4F-73-5E-4B-5B-2B-5C-6B-AB-56-A7-D6-94-B6-9C-B6-97-76-AE-76-8B-F6-03-1D-B2-8E-83-CE-1A-9D-06-9D-5B-BA-18-5D-86-6E-B2-EE-3E-DD-1B-7A-B0-9E-85-5E-A2-5E-8D-DE-75-7D-58-DF-52-9F-AB-BF-4F-7F-D0-00-6D-60-6D-C0-33-68-30-18-31-24-19-3A-19-66-1A-B6-18-8E-19-D1-8C-7C-8D-F2-8D-3A-8D-9E-1B-6B-18-47-19-EF-32-EE-33-FE-68-62-61-92-62-D2-68-72-DF-54-C6-D4-DB-34-DF-B4-DB-F4-77-33-3D-33-96-59-8D-D9-2D-73-B2-B9-BB-F9-06-F3-2E-F3-17-CB-F4-97-71-96-ED-5F-76-C7-82-62-E1-67-B1-D5-A2-C7-E2-83-A5-95-25-DF-B2-D5-72-DA-4A-C3-2A-D6-AA-D6-6A-84-41-65-04-30-4A-18-97-AD-D1-D6-CE-D6-1B-AC-4F-59-BF-B5-B1-B4-11-D8-1C-B7-F9-CD-D6-D0-36-D9-F6-88-ED-D4-72-ED-E5-9C-E5-8D-CB-C7-ED-D4-EC-98-76-F5-76-A3-F6-74-FB-58-FB-03-F6-A3-0E-AA-0E-4C-87-06-87-C7-8E-EA-8E-6C-C7-26-C7-49-27-5D-A7-24-A7-A3-4E-CF-9D-4D-9C-F9-CE-ED-CE-F3-2E-36-2E-EB-5C-CE-B9-22-AE-1E-AE-45-AE-03-6E-32-6E-A1-6E-D5-6E-8F-DC-D5-DC-13-DC-5B-DC-67-3D-2C-3C-D6-7A-9C-F3-44-7B-FA-78-EE-F2-1C-F1-52-F2-62-79-35-7B-CD-7A-5B-79-AF-F3-EE-F5-21-F9-04-FB-54-FB-3C-F6-D5-F3-E5-FB-76-FB-C1-7E-DE-7E-BB-FD-1E-AC-D0-5C-C1-5B-D1-E9-0F-FC-BD-FC-77-FB-3F-0C-D0-0E-58-13-F0-63-20-26-30-20-B0-26-F0-49-90-69-50-5E-50-5F-30-25-38-26-F8-48-F0-EB-10-E7-90-D2-90-FB-A1-3A-A1-C2-D0-9E-30-C9-B0-E8-B0-E6-B0-F9-70-D7-F0-B2-F0-D1-08-E3-88-75-11-D7-22-15-22-B9-91-5D-51-D8-A8-B0-A8-A6-A8-B9-95-6E-2B-F7-AC-9C-88-B6-88-2E-8C-1E-5E-A5-BD-2A-7B-D5-95-D5-0A-AB-53-56-9F-8E-91-8C-61-C6-9C-88-45-C7-86-C7-1E-89-7D-CF-F4-67-36-30-E7-E2-BC-E2-6A-E3-66-59-2E-AC-BD-AC-67-6C-47-76-39-7B-9A-63-C7-29-E3-4C-C6-DB-C5-97-C5-4F-25-D8-25-EC-4E-98-4E-74-48-AC-48-9C-E1-BA-70-AB-B9-2F-92-3C-93-EA-92-E6-93-FD-93-0F-25-7F-4A-09-4F-69-4B-C5-A5-C6-A6-9E-E4-C9-F0-92-79-BD-69-CA-69-D9-69-83-E9-FA-E9-85-E9-A3-6B-6C-D6-EC-59-33-CB-F7-E1-37-65-40-19-AB-32-BA-04-54-D1-CF-54-BF-50-47-B8-45-38-96-69-9F-59-93-F9-26-2B-2C-EB-44-B6-74-36-2F-BB-3F-47-2F-67-7B-CE-64-AE-7B-EE-B7-6B-51-6B-59-6B-7B-F2-54-F3-36-E5-8D-AD-73-5A-57-BF-1E-5A-1F-B7-BE-67-83-FA-86-82-0D-13-1B-3D-36-1E-DE-44-D8-94-BC-E9-A7-7C-93-FC-B2-FC-57-9B-C3-37-77-17-28-15-6C-2C-18-DF-E2-B1-A5-A5-50-A2-90-5F-38-B2-D5-76-6B-DD-36-D4-36-EE-B6-81-ED-E6-DB-AB-B6-7F-2C-62-17-5D-2D-36-29-AE-28-7E-5F-C2-2A-B9-FA-8D-E9-37-95-DF-7C-DA-11-BF-63-A0-D4-B2-74-FF-4E-CC-4E-DE-CE-E1-5D-0E-BB-0E-97-49-97-E5-96-8D-EF-F6-DB-DD-51-4E-2F-2F-2A-7F-B5-27-66-CF-95-8A-65-15-75-7B-09-7B-85-7B-47-2B-7D-2B-BB-AA-34-AA-76-56-BD-AF-4E-AC-BE-5D-E3-5C-D3-56-AB-58-BB-BD-76-7E-1F-7B-DF-D0-7E-C7-FD-AD-75-4A-75-C5-75-EF-0E-70-0F-DC-A9-F7-A8-EF-68-D0-6A-A8-38-88-39-98-79-F0-49-63-58-63-DF-B7-8C-6F-9B-9B-14-9A-8A-9B-3E-1C-E2-1D-1A-3D-1C-74-B8-B7-D9-AA-B9-F9-88-E2-91-D2-16-B8-45-D8-32-7D-34-FA-E8-8D-EF-5C-BF-EB-6A-35-6C-AD-6F-A3-B5-15-1F-03-C7-84-C7-9E-7E-1F-FB-FD-F0-71-9F-E3-3D-27-18-27-5A-7F-D0-FC-A1-B6-9D-D2-5E-D4-01-75-E4-74-CC-76-26-76-8E-76-45-76-0D-9E-F4-3E-D9-D3-6D-DB-DD-FE-A3-D1-8F-87-4E-A9-9E-AA-39-2D-7B-BA-F4-0C-E1-4C-C1-99-4F-67-73-CF-CE-9D-4B-3F-37-73-3E-E1-FC-78-4F-4C-CF-FD-0B-11-17-6E-F5-06-F6-0E-5C-F4-B9-78-F9-92-FB-A5-0B-7D-4E-7D-67-2F-DB-5D-3E-75-C5-E6-CA-C9-AB-8C-AB-9D-D7-2C-AF-75-F4-5B-F4-B7-FF-64-F1-53-FB-80-E5-40-C7-75-AB-EB-5D-37-AC-6F-74-0F-2E-1F-3C-33-E4-30-74-FE-A6-EB-CD-4B-B7-BC-6E-5D-BB-BD-E2-F6-E0-70-E8-F0-9D-91-E8-91-D1-3B-EC-3B-53-77-53-EE-BE-B8-97-79-6F-E1-FE-C6-07-E8-07-45-0F-A5-1E-56-3C-52-7C-D4-F0-B3-EE-CF-6D-A3-96-A3-A7-C7-5C-C7-FA-1F-07-3F-BE-3F-CE-1A-7F-F6-4B-C6-2F-EF-27-0A-9E-90-9F-54-4C-AA-4C-36-4F-99-4D-9D-9A-76-9F-BE-F1-74-E5-D3-89-67-E9-CF-16-66-0A-7F-95-FE-B5-F6-B9-CE-F3-1F-7E-73-FC-AD-7F-36-62-76-E2-05-FF-C5-A7-DF-4B-5E-CA-BF-3C-F4-6A-D9-AB-9E-B9-80-B9-47-AF-53-5F-2F-CC-17-BD-91-7F-73-F8-2D-E3-6D-DF-BB-F0-77-93-0B-59-EF-B1-EF-2B-3F-E8-7E-E8-FE-E8-F3-F1-C1-A7-D4-4F-9F-FE-05-03-98-F3-FC-BA-C4-E8-D3-00-00-00-09-70-48-59-73-00-00-2E-23-00-00-2E-23-01-78-A5-3F-76-00-00-00-65-49-44-41-54-48-4B-63-78-48-33-00-32-FA-FF-7F-06-AA-A3-51-A3-D1-10-16-A3-5F-BF-9E-F2-FC-F9-16-32-10-50-23-B2-39-58-8C-7E-F6-6C-27-50-84-0C-00-D4-88-6C-0E-50-04-BB-D1-48-02-44-A1-51-A3-D1-D0-B0-37-9A-0C-40-D8-E8-57-AF-16-3E-7D-7A-98-0C-04-D4-88-6C-0E-16-A3-A9-85-46-8D-46-43-20-A3-D1-62-83-6A-E8-E9-61-00-6A-96-23-64-72-DD-76-9A-00-00-00-00-49-45-4E-44-AE-42-60-82";

            Assert.AreEqual(BitConverter.ToString(resBytes), res);
            //compareTwoImages(test, testImg);
        }

        [TestMethod]
        public void testWriteImg()
        {
            var ioRepository = Substitute.For<ImageEdgeDetection.IOFiles.IReadWriteController>();

            ioRepository.write(new Bitmap("../../imagesForTesting/testImg.png"));
        }

        [TestMethod]
        public void testGaussian()
        {
            var logicRepository = Substitute.For<ImageEdgeDetection.Business.ILogicController>();

            logicRepository.gaussianEdge(null);
        }


        public void compareTwoImages(Bitmap bmp1, Bitmap bmp2)
        {
            //code from http://csharpexamples.com/c-fast-bitmap-compare/
            int bytes = bmp1.Width * bmp1.Height * (Image.GetPixelFormatSize(bmp1.PixelFormat) / 8);

            bool result = true;
            byte[] b1bytes = new byte[bytes];
            byte[] b2bytes = new byte[bytes];

            BitmapData bitmapData1 = bmp1.LockBits(new Rectangle(0, 0, bmp1.Width, bmp1.Height), ImageLockMode.ReadOnly, bmp1.PixelFormat);
            BitmapData bitmapData2 = bmp2.LockBits(new Rectangle(0, 0, bmp2.Width, bmp2.Height), ImageLockMode.ReadOnly, bmp2.PixelFormat);

            Marshal.Copy(bitmapData1.Scan0, b1bytes, 0, bytes);
            Marshal.Copy(bitmapData2.Scan0, b2bytes, 0, bytes);

            for (int n = 0; n <= bytes - 1; n++)
            {
                if (b1bytes[n] != b2bytes[n])
                {
                    result = false;
                    break;
                }
            }

            Assert.AreEqual(true, result);
            bmp1.UnlockBits(bitmapData1);
            bmp2.UnlockBits(bitmapData2);
        }

    }
}
    